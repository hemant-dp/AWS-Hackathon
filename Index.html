<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serverless Agent (Error Proof)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="bg-gradient-to-r from-gray-900 to-gray-800 rounded-lg shadow-lg p-6 mb-8 text-white">
            <h1 class="text-3xl font-bold mb-2">üöÄ Serverless System Design Agent</h1>
            <p class="text-gray-300">Robust Error Handling for Grok, Llama & Gemini</p>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6 border-l-4 border-gray-800">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">1. AI Platform</label>
                    <select id="apiPlatform" onchange="updateUI()" class="w-full px-4 py-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="gemini">Google Gemini (Direct - Stable)</option>
                        <option value="openrouter" selected>OpenRouter AI (Aggregator)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">2. Select Model</label>
                    
                    <select id="geminiModel" class="hidden w-full px-4 py-3 border border-gray-300 rounded-lg outline-none bg-blue-50">
                        <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash (Best & Free)</option>
                        <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro (Smartest)</option>
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Experimental)</option>
                    </select>

                    <select id="openRouterModel" class="w-full px-4 py-3 border border-gray-300 rounded-lg outline-none bg-purple-50">
                        <optgroup label="üöÄ New & Trending (Free)">
                            <option value="x-ai/grok-4.1-fast:free" selected>Grok 4.1 Fast (FREE)</option>
                            <option value="meta-llama/llama-3.3-70b-instruct:free">Llama 3.3 70B (FREE)</option>
                            <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash (FREE)</option>
                        </optgroup>
                        <optgroup label="üß† Reasoning Models">
                            <option value="deepseek/deepseek-r1:free">DeepSeek R1 (Thinking)</option>
                            <option value="google/gemini-2.0-flash-thinking-exp:free">Gemini 2.0 Thinking</option>
                        </optgroup>
                    </select>
                </div>
            </div>

            <div class="mt-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">3. API Key</label>
                <input type="password" id="apiKey" placeholder="Enter API Key..." class="w-full px-4 py-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
                <p id="keyHelp" class="text-xs text-gray-500 mt-1">Get OpenRouter Key: <a href="https://openrouter.ai/keys" target="_blank" class="text-blue-600 underline">openrouter.ai</a></p>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-2">System Requirement</label>
            <textarea id="userRequirement" rows="5" class="w-full px-4 py-3 border border-gray-300 rounded-lg outline-none resize-y" placeholder="Example: Build a serverless URL shortener service using Lambda and DynamoDB..."></textarea>
            
            <button id="generateBtn" onclick="generateDesignAndCode()" class="mt-4 w-full bg-gray-900 hover:bg-black text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition">
                <span id="btnText">Generate Design & Code</span>
                <div id="spinner" class="spinner hidden"></div>
            </button>
        </div>

        <div id="errorBox" class="hidden bg-red-50 border-l-4 border-red-500 rounded-lg p-4 mb-6">
            <div class="flex">
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">Error</h3>
                    <div id="errorMessage" class="mt-1 text-sm text-red-700"></div>
                </div>
            </div>
        </div>

        <div id="outputContainer" class="hidden space-y-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">üìê Visual Architecture</h2>
                <div id="mermaidDiagram" class="bg-gray-50 rounded-lg p-4 overflow-x-auto border border-gray-200 min-h-[100px]"></div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">üìã Design JSON</h2>
                <div class="bg-gray-900 rounded-lg p-4 overflow-auto max-h-64"><pre id="designJson" class="text-green-400 text-sm font-mono"></pre></div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">üíª CDK Code</h2>
                    <button onclick="copyCode()" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200">Copy Code</button>
                </div>
                <div class="bg-gray-900 rounded-lg p-4 overflow-auto max-h-[500px]"><pre id="cdkCode" class="text-blue-300 text-sm font-mono"></pre></div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Mermaid safely
        mermaid.initialize({ 
            startOnLoad: false, 
            theme: 'default',
            securityLevel: 'loose',
            suppressErrorRendering: true // ERROR FIX: Ye red error box ko rokega
        });

        function updateUI() {
            const platform = document.getElementById('apiPlatform').value;
            const geminiSelect = document.getElementById('geminiModel');
            const openRouterSelect = document.getElementById('openRouterModel');
            const keyHelp = document.getElementById('keyHelp');
            const apiKey = document.getElementById('apiKey');

            if(platform === 'gemini') {
                geminiSelect.classList.remove('hidden');
                openRouterSelect.classList.add('hidden');
                apiKey.placeholder = "Enter Google Gemini API Key (AIza...)";
                keyHelp.innerHTML = "Get free key from <a href='https://aistudio.google.com/' target='_blank' class='text-blue-600 underline'>Google AI Studio</a>";
            } else {
                geminiSelect.classList.add('hidden');
                openRouterSelect.classList.remove('hidden');
                apiKey.placeholder = "Enter OpenRouter API Key (sk-or-...)";
                keyHelp.innerHTML = "Get key from <a href='https://openrouter.ai/keys' target='_blank' class='text-blue-600 underline'>openrouter.ai</a>";
            }
        }

        async function generateDesignAndCode() {
            const platform = document.getElementById('apiPlatform').value;
            const apiKey = document.getElementById('apiKey').value.trim();
            const userReq = document.getElementById('userRequirement').value.trim();
            
            const model = platform === 'gemini' 
                ? document.getElementById('geminiModel').value 
                : document.getElementById('openRouterModel').value;

            const btn = document.getElementById('generateBtn');
            const btnText = document.getElementById('btnText');
            const spinner = document.getElementById('spinner');
            const errorBox = document.getElementById('errorBox');
            const outputContainer = document.getElementById('outputContainer');

            errorBox.classList.add('hidden');
            outputContainer.classList.add('hidden');

            if (!apiKey) return showError("Please enter an API Key.");
            if (!userReq) return showError("Please describe your system.");
            
            btn.disabled = true;
            spinner.classList.remove('hidden');
            btnText.textContent = "Architecting...";

            try {
                // Step 1: Design
                const designJson = await callAI(platform, model, apiKey, userReq, 'design');
                
                // RENDER FIX: Handle diagram errors separately without stopping execution
                try {
                    await renderDiagram(designJson.mermaidGraphDefinition);
                } catch (renderError) {
                    console.warn("Diagram failed to render, but continuing to code generation...");
                }
                
                document.getElementById('designJson').textContent = JSON.stringify(designJson, null, 2);

                // Step 2: Code
                btnText.textContent = "Writing Code...";
                const code = await callAI(platform, model, apiKey, JSON.stringify(designJson), 'code');
                document.getElementById('cdkCode').textContent = code;
                
                outputContainer.classList.remove('hidden');
                outputContainer.scrollIntoView({ behavior: 'smooth' });

            } catch (e) {
                showError(e.message);
            } finally {
                btn.disabled = false;
                spinner.classList.add('hidden');
                btnText.textContent = "Generate Design & Code";
            }
        }

        async function callAI(platform, model, apiKey, input, mode) {
            const isJson = mode === 'design';
            
            const systemPrompt = isJson 
                ? `You are a System Architect. Create a serverless architecture. 
                   CRITICAL: Return ONLY valid JSON with this structure:
                   { 
                     "mermaidGraphDefinition": "graph TD...", 
                     "primaryServices": ["Lambda", "DynamoDB"...], 
                     "highLevelDescription": "..." 
                   }
                   Ensure the mermaid graph syntax is simple and standard.
                   Do NOT use markdown code blocks. Just the raw JSON string.`
                : `You are an AWS CDK Expert. Generate Python CDK code. 
                   CRITICAL: Return ONLY the raw Python code. Do NOT use markdown code blocks.`;

            let url, body, headers;

            if (platform === 'gemini') {
                url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                headers = { 'Content-Type': 'application/json' };
                body = JSON.stringify({
                    contents: [{ parts: [{ text: systemPrompt + "\n\nUser Input: " + input }] }],
                    generationConfig: {
                        temperature: 0.2,
                        responseMimeType: isJson ? "application/json" : "text/plain"
                    }
                });
            } else if (platform === 'openrouter') {
                url = "https://openrouter.ai/api/v1/chat/completions";
                headers = {
                    "Authorization": `Bearer ${apiKey}`,
                    "Content-Type": "application/json",
                    "HTTP-Referer": "https://serverless-agent.local",
                    "X-Title": "Serverless Agent Local"
                };
                
                const payload = {
                    model: model,
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: input }
                    ],
                    temperature: 0.2,
                };

                if (isJson) payload.response_format = { type: "json_object" };

                body = JSON.stringify(payload);
            }

            const response = await fetch(url, { method: 'POST', headers: headers, body: body });
            const data = await response.json();

            if (data.error) {
                if (data.error.message) {
                     if (data.error.message.includes("Provider returned error")) {
                        throw new Error(`Model Busy. Please switch to Google Gemini (Direct).`);
                    }
                    throw new Error(`API Error: ${data.error.message}`);
                }
                throw new Error(`API Error: ${JSON.stringify(data.error)}`);
            }

            let text = "";
            if (platform === 'gemini') {
                text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            } else {
                text = data.choices?.[0]?.message?.content;
            }

            if (!text) throw new Error("Received empty response from AI.");
            text = text.replace(/```json|```python|```/g, '').trim();

            return isJson ? JSON.parse(text) : text;
        }

        // IMPROVED RENDER FUNCTION
        async function renderDiagram(def) {
            const el = document.getElementById('mermaidDiagram');
            el.innerHTML = '<div class="text-gray-500 animate-pulse">Rendering diagram...</div>';
            
            // Clean up common AI syntax mistakes
            let cleanDef = def.replace(/```mermaid/g, '').replace(/```/g, '').trim();
            if (!cleanDef.startsWith('graph')) cleanDef = 'graph TD\n' + cleanDef;

            try {
                // Try rendering
                const { svg } = await mermaid.render('graphDiv', cleanDef);
                el.innerHTML = svg;
            } catch (e) {
                console.error("Mermaid Render Error:", e);
                // Fallback UI instead of crashing
                el.innerHTML = `
                    <div class="p-4 bg-yellow-50 text-yellow-700 rounded border border-yellow-200">
                        <p class="font-bold flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            Visual Diagram Skipped
                        </p>
                        <p class="text-sm mt-1">The AI generated complex syntax that the visualizer couldn't parse. <strong>Don't worry, the Python Code below is still valid!</strong></p>
                    </div>
                `;
            }
        }

        function showError(msg) {
            document.getElementById('errorBox').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = msg;
        }

        function copyCode() {
            navigator.clipboard.writeText(document.getElementById('cdkCode').textContent);
            alert("Code copied!");
        }
        
        updateUI();
    </script>
</body>
</html>